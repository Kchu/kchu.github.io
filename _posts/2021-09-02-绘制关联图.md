---
layout: post
title:  "Python绘制关联图"
date:   2021-09-02 13:30:56 +0800
<!-- categories: RL -->
tags: Python 技能
---

* content
{:toc}

# 1. 根据源数据写json文件 
## 对每个圆设置随机颜色
```python
def randomcolor_func():
  color_char = ['1','2','3','4','5','6','7','8','9','A','B','C','D','E','F']
  color_code = ""
  for i in range(6):
    color_code += color_char[random.randint(0,14)] # randint包括前后节点0和14
  return "#"+color_code
```

## 生成每个圆心的坐标 (根据圆的参数方程进行)
```python
r = 10
a, b = (0, 0)
theta = np.arange(0, 2*np.pi, 0.36)
X = a + r * np.cos(theta)
Y = b + r * np.sin(theta)
```

## 构造连接图（节点和边）
```python
def create_json(data, weights):
  # 自定义节点
  address_dict = {"nodes":[], "edges":[]}
  node_dict = {
      "color": "",
      "label": "",
      "attributes": {},
      "y": None,
      "x": None,
      "id": "",
      "size": None
    }
  edge_dict = {
      "sourceID": "",
      "attributes": {},
      "targetID": "",
      "size": None
    }
    
  # 存储每个节点的数据
  for ii in range(len(data)):
    # for jj in range(len(data.iloc[ii])):
    jj = 0
    # node，"attributes"属性可自行设置
    node_dict[r"color"] = randomcolor_func()
    node_dict[r"label"] = data.iloc[ii, jj]
    x, y = X[ii], Y[ii]
    node_dict[r"y"] = y
    node_dict[r"x"] = x
    node_dict[r"id"] = data.iloc[ii, jj]
    node_dict[r"size"] = int(weights.loc[data.iloc[ii, jj]])
    
    tmp_node = copy.deepcopy(node_dict)
    address_dict[r"nodes"].append(tmp_node)

  # 存储每个边的数据
  for ii in range(len(data)):
    for jj in range(1, len(data.iloc[ii])):    
      # edge
      edge_dict[r"sourceID"] = data.iloc[ii, 0]
      edge_dict[r"targetID"] = data.iloc[ii, jj]
      edge_dict[r"size"] = 10
        
      tmp_edge = copy.deepcopy(edge_dict)
      address_dict["edges"].append(tmp_edge)
    
  return address_dict
```
### main函数
```python
if __name__ == '__main__': 
  # read data
    data = pd.read_excel(r'connection_data.xlsx', 0)

    weights = pd.DataFrame({"比例":[90, 66, 36, 30, 24, 24, 12, 12, 12, 12, 12, 12, 6, 6, 6, 6, 6]}, 
              index = ['美国','中国','德国','希腊','西班牙','英国','意大利','丹麦','奥地利','韩国','新加坡','瑞典', '瑞士', '波兰', '澳大利亚', '爱尔兰', '法国']) #建立索引权值列表

    address_dict = create_json(data, weights)
   
    with open("connection_data.json", "w", encoding='utf-8') as f:
    # json.dump(dict_, f) # 写为一行
        json.dump(address_dict, f, indent=2, ensure_ascii=False) # 写为多行
```

# 2. 绘图
```python
with open(r".\connection_data.json", encoding='utf-8') as f: #设置以utf-8解码模式读取文件，encoding参数必须设置，否则默认以gbk模式读取文件，当文件中包含中文时，会报错
    data = json.load(f)
    
nodes = [
  {
    "x": node["x"],
    "y": node["y"],
    "id": node["id"],
    "name": node["label"],
    "symbolSize": node["size"],
    "itemStyle": {"normal": {"color": node["color"]}},
  }
  for node in data["nodes"]
]
 
edges = [{"source": edge["sourceID"], "target": edge["targetID"]} for edge in data["edges"]]

(
  Graph(init_opts=opts.InitOpts(width="1600px", height="800px"))
  .add(
    series_name="",
    nodes=nodes,
    links=edges,
    layout="none",
    is_roam=True,
    is_focusnode=True,
    label_opts=opts.LabelOpts(is_show=True, font_size=20),
    # linestyle_opts=opts.LineStyleOpts(width=0.5, curve=0.3, opacity=0.7),
    linestyle_opts=opts.LineStyleOpts(width=2, curve=0.3, opacity=0.7),
  )
  .set_global_opts(title_opts=opts.TitleOpts())
  .render("Connection-Graph.html")
)
```

# 3. 成果图
![png1](https://raw.githubusercontent.com/Kchu/kchu.github.io/master/img/connect_graph_1.png)
![png2](https://raw.githubusercontent.com/Kchu/kchu.github.io/master/img/connect_graph_2.png)